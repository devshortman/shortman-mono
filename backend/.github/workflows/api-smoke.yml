name: API Smoke

on:
  push:
    paths:
      - "backend/**"
      - ".github/workflows/api-smoke.yml"
  pull_request:
    paths:
      - "backend/**"
      - ".github/workflows/api-smoke.yml"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # 0) 소스 체크아웃 (루트: short-man_backend/)
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Python 3.11 + pip 캐시
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      # 2) 의존성 설치 (루트에서 backend/requirements.txt 지정)
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      # 3) 모듈 import 스모크 테스트
      - name: Import modules
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          APP_ENV: "ci"        # 선택이지만 있어도 좋음
        run: |
          python - <<'PY'
          import importlib
          # 리포지토리 루트 기준으로 backend 패키지 import
          importlib.import_module("backend")
          importlib.import_module("backend.config")
          importlib.import_module("backend.app.main")
          print("✅ imports ok")
          PY

      # 4) ENV 확인(실행 위치 확인용, 필수는 아님)
      - name: Env smoke (no secrets required)
        run: |
          python - <<'PY'
          from pathlib import Path
          print("cwd        ->", Path.cwd())
          print("repo root  ->", Path.cwd())
          print("backend dir->", Path.cwd() / "backend")
          PY

      # 5) uvicorn을 백그라운드로 띄우고 /trends 헬스 체크
      - name: Launch API (background)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -e
          cd backend
          nohup uvicorn backend.app.main:app \
            --host 127.0.0.1 \
            --port 8001 > /tmp/uvicorn.log 2>&1 &
          echo $! > /tmp/uvicorn.pid
          sleep 5

      - name: Hit /trends
        run: |
          set -e
          curl -sSf http://127.0.0.1:8001/trends | head -c 400
          echo

      - name: Show uvicorn logs (on failure)
        if: failure()
        run: |
          echo "==== uvicorn.log ===="
          cat /tmp/uvicorn.log || true

      - name: Stop API
        if: always()
        run: |
          if [ -f /tmp/uvicorn.pid ]; then
            kill "$(cat /tmp/uvicorn.pid)" || true
          fi