name: Check Secrets (fail-fast + optional connectivity)

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      # 1) 필수 시크릿 존재 여부 (초고속, 실패 시 즉시 중단)
      - name: Assert required secrets exist
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}  # 선택
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}                # 선택
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}                # 선택
        run: |
          set -e
          fail=0
          required=(SUPABASE_URL SUPABASE_SERVICE_ROLE_KEY)
          for k in "${required[@]}"; do
            v="${!k}"
            if [ -z "$v" ]; then
              echo "::error title=Missing secret::$k is empty"
              fail=1
            fi
          done
          # 선택 시크릿은 있으면 좋고, 없으면 경고만
          for k in VITE_SUPABASE_ANON_KEY SUPABASE_DB_URL YOUTUBE_API_KEY; do
            v="${!k}"
            if [ -z "$v" ]; then
              echo "::warning title=Optional secret::$k is empty"
            fi
          done
          exit $fail

      # 2) (선택) REST reachability — 익명키가 있을 때만 실행
      - name: Quick REST reachability (anon, read-only)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: |
          if [ -z "$VITE_SUPABASE_ANON_KEY" ]; then
            echo "Skip REST check: VITE_SUPABASE_ANON_KEY not set"
            exit 0
          fi
          set -e
          curl -sS -I "${SUPABASE_URL}/rest/v1/" \
            -H "apikey: ${VITE_SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${VITE_SUPABASE_ANON_KEY}" | head -n 1
          echo "REST reachable with anon key"

      # 3) (선택) DB 연결 확인 — DB URL 있을 때만 실행 (psql 설치 포함)
      - name: DB connectivity check via psql (no secrets printed)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "Skip DB check: SUPABASE_DB_URL not set"
            exit 0
          fi
          set -e
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y postgresql-client >/dev/null
          psql "$SUPABASE_DB_URL" -v ON_ERROR_STOP=1 -c "select 1 as ok;"
          echo "psql connected using SUPABASE_DB_URL"

      # 4) (선택) 안전한 에코 — 값 자체는 출력하지 않고 존재 여부만
      - name: Echo only safe values (no secrets printed)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          echo "Has SUPABASE_URL? $([[ -n "$SUPABASE_URL" ]] && echo YES || echo NO)"
          echo "Has VITE_SUPABASE_ANON_KEY? $([[ -n "$VITE_SUPABASE_ANON_KEY" ]] && echo YES || echo NO)"
          echo "Has SUPABASE_SERVICE_ROLE_KEY? $([[ -n "$SUPABASE_SERVICE_ROLE_KEY" ]] && echo YES || echo NO)"
          echo "Has SUPABASE_DB_URL? $([[ -n "$SUPABASE_DB_URL" ]] && echo YES || echo NO)"
          echo "Has YOUTUBE_API_KEY? $([[ -n "$YOUTUBE_API_KEY" ]] && echo YES || echo NO)"